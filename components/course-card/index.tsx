"use client";

import { getCourseBooks } from "@/actions/get-course-books";
import { useAlanCommand } from "@/hooks/use-alan-command";
import { getCourseContents } from "@/lib/helper-methods";
import { CourseDataType } from "@/lib/types";
import { cn } from "@/lib/utils";
import { BookImage } from "lucide-react";
import { useRouter } from "next/navigation";
import { useEffect, useState } from "react";
import BookHoverCard from "../book-hover-card";
import { Badge } from "../ui/badge";
import UserAvatar from "../user-avatar";

interface Props {
  course: CourseDataType;
  serial_number: number;
  showActiveBadge?: () => boolean;
}

type BookType = {
  id: number;
  name: string;
  image: string;
};

const CourseCard = ({ course, serial_number, showActiveBadge }: Props) => {
  const router = useRouter();

  const alan = useAlanCommand();
  const courseContents = getCourseContents(course);
  const [books, setBooks] = useState<BookType[]>([]);

  useEffect(() => {
    (async () => {
      const bookList = await getCourseBooks(course);
      setBooks(bookList);
    })();
  }, [course]);

  const isActive = showActiveBadge ? showActiveBadge() : false;

  //alan
  // const [alanSelected, setAlanSelect] = useState(false);
  // useEffect(() => {
  //   console.log(alan);
  //   if (alan.commandData) {
  //     if (alan.commandData?.command === "hightlight") {
  //       if (alan.commandData?.course?.id === course.id) {
  //         setAlanSelect(true);
  //       } else {
  //         setAlanSelect(false);
  //       }
  //       // Call client code that will react to the received command
  //     }
  //   }
  // }, [alan, course]);

  return (
    <div
      className={cn(
        "bg-white shadow-md shadow-[var(--brand-shadow)] p-4 rounded-md w-full border flex flex-col gap-y-6 h-full cursor-pointer hover:bg-slate-50 relative"
        // alanSelected && "border-2 border-[var(--brand-color)]"
      )}
      onClick={() => router.push(`/course/${course?.slug}`)}
    >
      <div className="absolute top-1 right-1 bg-white">
        {isActive && <Badge className="bg-[var(--brand-color)]">Active</Badge>}
      </div>
      <div className="flex flex-col">
        <span className="text-[10px] text-slate-400 tracking-tight font-semibold">
          Course {serial_number}
        </span>
        <span className="text-xs font-semibold text-slate-400 tracking-tight line-clamp-1 lowercase">
          {course?.course_name}
        </span>
      </div>

      <div className="space-y-1 flex flex-col justify-end flex-grow">
        <h2 className="text-base text-slate-900 tracking-tight font-semibold line-clamp-2">
          {course?.collection_name}
        </h2>
        <div className="flex items-center justify-between gap-x-4 w-full flex-wrap">
          <div className="flex shrink-0 items-center justify-between gap-x-2">
            <UserAvatar
              className="w-6 h-6"
              fallbackName={course?.educator_name}
            />
            <span
              className="text-slate-700 tracking-tight font-semibold text-sm hover:underline"
              onClick={(e) => e.preventDefault()}
            >
              {course?.educator_name}
            </span>
          </div>
          <div className="w-fit flex items-center gap-x-2">
            <div className="flex items-center gap-x-2">
              {books.map((book) => (
                <BookHoverCard key={book.id} bookId={book.id}>
                  <button key={book.id} className="border">
                    {book.image ? (
                      <UserAvatar
                        src={book.image}
                        className="border-0 rounded-none w-4 h-5"
                      />
                    ) : (
                      <span>
                        <BookImage className="w-5 h-6" />
                      </span>
                    )}
                  </button>
                </BookHoverCard>
              ))}
            </div>
            <div className="w-[1px] h-3 bg-slate-300 shrink-0 rounded-md" />
            <div className="flex items-center gap-x-2">
              {/* images */}
              <div className="flex items-center gap-x-1">
                <svg
                  width="12"
                  height="12"
                  viewBox="0 0 12 12"
                  fill="none"
                  xmlns="http://www.w3.org/2000/svg"
                >
                  <path
                    d="M10.2 0H1.8C1.32261 0 0.864773 0.189642 0.527208 0.527208C0.189642 0.864773 0 1.32261 0 1.8V10.2C0 10.6774 0.189642 11.1352 0.527208 11.4728C0.864773 11.8104 1.32261 12 1.8 12H10.2C10.2987 11.9986 10.3971 11.9886 10.494 11.97L10.674 11.928H10.716H10.746L10.968 11.844L11.046 11.802C11.106 11.766 11.172 11.736 11.232 11.694C11.3121 11.6351 11.3883 11.5709 11.46 11.502L11.502 11.448C11.5609 11.3883 11.6151 11.3241 11.664 11.256L11.718 11.178C11.7599 11.1112 11.796 11.0409 11.826 10.968C11.8425 10.9392 11.8565 10.9091 11.868 10.878C11.898 10.806 11.916 10.728 11.94 10.65V10.56C11.974 10.4428 11.9942 10.3219 12 10.2V1.8C12 1.32261 11.8104 0.864773 11.4728 0.527208C11.1352 0.189642 10.6774 0 10.2 0ZM1.8 10.8C1.64087 10.8 1.48826 10.7368 1.37574 10.6243C1.26321 10.5117 1.2 10.3591 1.2 10.2V7.614L3.174 5.634C3.22978 5.57776 3.29614 5.53313 3.36925 5.50267C3.44237 5.4722 3.52079 5.45652 3.6 5.45652C3.67921 5.45652 3.75763 5.4722 3.83075 5.50267C3.90386 5.53313 3.97022 5.57776 4.026 5.634L9.186 10.8H1.8ZM10.8 10.2C10.7994 10.274 10.7852 10.3472 10.758 10.416C10.7443 10.4452 10.7282 10.4733 10.71 10.5C10.6939 10.5254 10.6759 10.5495 10.656 10.572L7.446 7.362L7.974 6.834C8.02978 6.77776 8.09614 6.73313 8.16925 6.70267C8.24237 6.6722 8.32079 6.65652 8.4 6.65652C8.47921 6.65652 8.55763 6.6722 8.63075 6.70267C8.70386 6.73313 8.77022 6.77776 8.826 6.834L10.8 8.814V10.2ZM10.8 7.116L9.672 6C9.32863 5.6742 8.87334 5.49257 8.4 5.49257C7.92666 5.49257 7.47137 5.6742 7.128 6L6.6 6.528L4.872 4.8C4.52863 4.4742 4.07334 4.29257 3.6 4.29257C3.12666 4.29257 2.67137 4.4742 2.328 4.8L1.2 5.916V1.8C1.2 1.64087 1.26321 1.48826 1.37574 1.37574C1.48826 1.26321 1.64087 1.2 1.8 1.2H10.2C10.3591 1.2 10.5117 1.26321 10.6243 1.37574C10.7368 1.48826 10.8 1.64087 10.8 1.8V7.116ZM6.9 2.4C6.722 2.4 6.54799 2.45278 6.39999 2.55168C6.25198 2.65057 6.13663 2.79113 6.06851 2.95559C6.00039 3.12004 5.98257 3.301 6.01729 3.47558C6.05202 3.65016 6.13774 3.81053 6.2636 3.9364C6.38947 4.06226 6.54984 4.14798 6.72442 4.18271C6.899 4.21743 7.07996 4.19961 7.24442 4.13149C7.40887 4.06337 7.54943 3.94802 7.64832 3.80001C7.74722 3.65201 7.8 3.478 7.8 3.3C7.8 3.06131 7.70518 2.83239 7.5364 2.6636C7.36761 2.49482 7.1387 2.4 6.9 2.4Z"
                    fill="#1BBEF1"
                  />
                </svg>
                <span className="text-slate-500 text-sm font-semibold">
                  {courseContents?.images?.length}
                </span>
              </div>

              {/* videos */}
              <div className="flex items-center gap-x-1">
                <svg
                  width="11"
                  height="12"
                  viewBox="0 0 11 12"
                  fill="none"
                  xmlns="http://www.w3.org/2000/svg"
                >
                  <path
                    d="M9.41362 3.99925L3.26526 0.305573C2.93256 0.104327 2.55495 -0.00109676 2.17077 8.60357e-06C1.78659 0.00111397 1.40953 0.108709 1.0779 0.311867C0.746263 0.515024 0.471863 0.806505 0.282569 1.1567C0.0932758 1.5069 -0.00416763 1.90334 0.000136659 2.30576V9.71979C0.000136659 10.3245 0.229472 10.9045 0.637691 11.3321C1.04591 11.7598 1.59958 12 2.17688 12C2.55905 11.9993 2.93435 11.8936 3.26526 11.6933L9.41362 7.99963C9.74398 7.79933 10.0183 7.51156 10.2089 7.16517C10.3996 6.81878 10.5 6.42596 10.5 6.02611C10.5 5.62625 10.3996 5.23343 10.2089 4.88704C10.0183 4.54066 9.74398 4.25288 9.41362 4.05259V3.99925ZM8.77714 6.79285L2.62878 10.5399C2.49098 10.6217 2.33528 10.6647 2.17688 10.6647C2.01849 10.6647 1.86279 10.6217 1.72499 10.5399C1.58757 10.4568 1.47346 10.3372 1.39414 10.1933C1.31481 10.0493 1.27306 9.886 1.27309 9.71979V2.27909C1.27306 2.11287 1.31481 1.94958 1.39414 1.80562C1.47346 1.66167 1.58757 1.54212 1.72499 1.45901C1.86336 1.37844 2.01859 1.33493 2.17688 1.33234C2.33507 1.33574 2.49012 1.3792 2.62878 1.45901L8.77714 5.17936C8.91461 5.26244 9.02877 5.38196 9.10814 5.52592C9.18752 5.66988 9.22931 5.83319 9.22931 5.99944C9.22931 6.16568 9.18752 6.329 9.10814 6.47296C9.02877 6.61692 8.91461 6.73644 8.77714 6.81951V6.79285Z"
                    fill="#1BBEF1"
                  />
                </svg>
                <span className="text-slate-500 text-sm font-semibold">
                  {courseContents?.videos?.length}
                </span>
              </div>

              {/* audios */}
              <div className="flex items-center gap-x-1">
                <svg
                  width="12"
                  height="12"
                  viewBox="0 0 12 12"
                  fill="none"
                  xmlns="http://www.w3.org/2000/svg"
                >
                  <path
                    d="M11.7893 0.144668C11.7239 0.0885447 11.6472 0.0471692 11.5644 0.0233572C11.4816 -0.000454819 11.3946 -0.00614439 11.3094 0.00667578L3.5098 1.20661C3.36777 1.22816 3.23818 1.29996 3.14459 1.40895C3.05101 1.51795 2.99964 1.65691 2.99983 1.80057V8.01022C2.71951 7.8733 2.41186 7.80152 2.09988 7.80024C1.68457 7.80024 1.27857 7.92339 0.933251 8.15413C0.587927 8.38487 0.31878 8.71282 0.159845 9.09653C0.000909843 9.48023 -0.0406748 9.90245 0.0403496 10.3098C0.121374 10.7171 0.321368 11.0913 0.615042 11.385C0.908716 11.6786 1.28288 11.8786 1.69022 11.9597C2.09755 12.0407 2.51977 11.9991 2.90347 11.8402C3.28718 11.6812 3.61513 11.4121 3.84587 11.0667C4.07661 10.7214 4.19976 10.3154 4.19976 9.90012V5.31638L10.7994 4.30243V6.81029C10.5191 6.67337 10.2114 6.60158 9.89944 6.6003C9.48412 6.6003 9.07813 6.72346 8.73281 6.9542C8.38749 7.18494 8.11834 7.51289 7.9594 7.8966C7.80047 8.2803 7.75888 8.70251 7.83991 9.10985C7.92093 9.51719 8.12093 9.89135 8.4146 10.185C8.70827 10.4787 9.08244 10.6787 9.48978 10.7597C9.89711 10.8407 10.3193 10.7992 10.703 10.6402C11.0867 10.4813 11.4147 10.2121 11.6454 9.86682C11.8762 9.52149 11.9993 9.1155 11.9993 8.70018V0.600642C11.9993 0.513983 11.9806 0.42835 11.9443 0.349637C11.9081 0.270923 11.8552 0.200997 11.7893 0.144668ZM2.09988 10.8001C1.92189 10.8001 1.74789 10.7473 1.5999 10.6484C1.4519 10.5495 1.33655 10.409 1.26844 10.2445C1.20032 10.0801 1.1825 9.89912 1.21723 9.72455C1.25195 9.54997 1.33766 9.38962 1.46352 9.26376C1.58938 9.1379 1.74974 9.05219 1.92431 9.01746C2.09888 8.98274 2.27983 9.00056 2.44428 9.06867C2.60872 9.13679 2.74927 9.25214 2.84816 9.40013C2.94705 9.54813 2.99983 9.72212 2.99983 9.90012C2.99983 10.1388 2.90502 10.3677 2.73624 10.5365C2.56747 10.7052 2.33856 10.8001 2.09988 10.8001ZM9.89944 9.60013C9.72145 9.60013 9.54745 9.54735 9.39946 9.44847C9.25146 9.34958 9.13611 9.20902 9.068 9.04458C8.99988 8.88014 8.98206 8.69919 9.01678 8.52461C9.05151 8.35004 9.13722 8.18968 9.26308 8.06382C9.38894 7.93796 9.5493 7.85225 9.72387 7.81753C9.89844 7.7828 10.0794 7.80063 10.2438 7.86874C10.4083 7.93686 10.5488 8.0522 10.6477 8.2002C10.7466 8.3482 10.7994 8.52219 10.7994 8.70018C10.7994 8.93887 10.7046 9.16777 10.5358 9.33654C10.367 9.50532 10.1381 9.60013 9.89944 9.60013ZM10.7994 3.0845L4.19976 4.09844V2.29855L10.7994 1.3026V3.0845Z"
                    fill="#1BBEF1"
                  />
                </svg>
                <span className="text-slate-500 text-sm font-semibold">
                  {courseContents?.audios?.length}
                </span>
              </div>

              {/* documents */}
              <div className="flex items-center gap-x-1">
                <svg
                  width="10"
                  height="12"
                  viewBox="0 0 10 12"
                  fill="none"
                  xmlns="http://www.w3.org/2000/svg"
                >
                  <path
                    d="M3 4.8H3.6C3.75913 4.8 3.91174 4.73679 4.02426 4.62426C4.13679 4.51174 4.2 4.35913 4.2 4.2C4.2 4.04087 4.13679 3.88826 4.02426 3.77574C3.91174 3.66321 3.75913 3.6 3.6 3.6H3C2.84087 3.6 2.68826 3.66321 2.57574 3.77574C2.46321 3.88826 2.4 4.04087 2.4 4.2C2.4 4.35913 2.46321 4.51174 2.57574 4.62426C2.68826 4.73679 2.84087 4.8 3 4.8ZM3 6C2.84087 6 2.68826 6.06321 2.57574 6.17574C2.46321 6.28826 2.4 6.44087 2.4 6.6C2.4 6.75913 2.46321 6.91174 2.57574 7.02426C2.68826 7.13679 2.84087 7.2 3 7.2H6.6C6.75913 7.2 6.91174 7.13679 7.02426 7.02426C7.13679 6.91174 7.2 6.75913 7.2 6.6C7.2 6.44087 7.13679 6.28826 7.02426 6.17574C6.91174 6.06321 6.75913 6 6.6 6H3ZM9.6 4.164C9.59375 4.10888 9.58168 4.05458 9.564 4.002V3.948C9.53515 3.88631 9.49667 3.8296 9.45 3.78L5.85 0.18C5.8004 0.13333 5.74369 0.0948486 5.682 0.0659999C5.66409 0.0634561 5.64591 0.0634561 5.628 0.0659999C5.56705 0.0310448 5.49973 0.00860652 5.43 0H1.8C1.32261 0 0.864773 0.189642 0.527208 0.527208C0.189642 0.864773 0 1.32261 0 1.8V10.2C0 10.6774 0.189642 11.1352 0.527208 11.4728C0.864773 11.8104 1.32261 12 1.8 12H7.8C8.27739 12 8.73523 11.8104 9.07279 11.4728C9.41036 11.1352 9.6 10.6774 9.6 10.2V4.2C9.6 4.2 9.6 4.2 9.6 4.164ZM6 2.046L7.554 3.6H6.6C6.44087 3.6 6.28826 3.53679 6.17574 3.42426C6.06321 3.31174 6 3.15913 6 3V2.046ZM8.4 10.2C8.4 10.3591 8.33679 10.5117 8.22427 10.6243C8.11174 10.7368 7.95913 10.8 7.8 10.8H1.8C1.64087 10.8 1.48826 10.7368 1.37574 10.6243C1.26321 10.5117 1.2 10.3591 1.2 10.2V1.8C1.2 1.64087 1.26321 1.48826 1.37574 1.37574C1.48826 1.26321 1.64087 1.2 1.8 1.2H4.8V3C4.8 3.47739 4.98964 3.93523 5.32721 4.27279C5.66477 4.61036 6.12261 4.8 6.6 4.8H8.4V10.2ZM6.6 8.4H3C2.84087 8.4 2.68826 8.46321 2.57574 8.57574C2.46321 8.68826 2.4 8.84087 2.4 9C2.4 9.15913 2.46321 9.31174 2.57574 9.42426C2.68826 9.53679 2.84087 9.6 3 9.6H6.6C6.75913 9.6 6.91174 9.53679 7.02426 9.42426C7.13679 9.31174 7.2 9.15913 7.2 9C7.2 8.84087 7.13679 8.68826 7.02426 8.57574C6.91174 8.46321 6.75913 8.4 6.6 8.4Z"
                    fill="#1BBEF1"
                  />
                </svg>
                <span className="text-slate-500 text-sm font-semibold">
                  {courseContents?.documens?.length}
                </span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
};

export default CourseCard;
